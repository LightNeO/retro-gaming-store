{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h2 class="text-center mb-4" style="color:#8be9fd;">Checkout</h2>
        <form id="checkout-form">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="name" required>
                </div>
                <div class="col-md-6">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="phone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="phone" pattern="[0-9\-\+\s]+" required>
                </div>
                <div class="col-md-6">
                    <label for="address" class="form-label">Shipping Address</label>
                    <input type="text" class="form-control" id="address" required>
                </div>
            </div>
            <hr>
            <h4 class="mb-3" style="color:#ff79c6;">Payment Details</h4>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="card-number" class="form-label">Card Number
                        <span tabindex="0" data-bs-toggle="tooltip" title="Test Card: 4242 4242 4242 4242">ðŸ›ˆ</span>
                    </label>
                    <input type="text" class="form-control" id="card-number" pattern="[0-9 ]{19}" maxlength="19" placeholder="4242 4242 4242 4242" required>
                </div>
                <div class="col-md-3">
                    <label for="card-expiry" class="form-label">Expiry (MM/YY)
                        <span tabindex="0" data-bs-toggle="tooltip" title="Test Expiry: 12/34">ðŸ›ˆ</span>
                    </label>
                    <input type="text" class="form-control" id="card-expiry" pattern="\d{2}/\d{2}" maxlength="5" placeholder="12/34" required>
                </div>
                <div class="col-md-3">
                    <label for="card-cvv" class="form-label">CVV
                        <span tabindex="0" data-bs-toggle="tooltip" title="Test CVV: 123">ðŸ›ˆ</span>
                    </label>
                    <input type="text" class="form-control" id="card-cvv" pattern="\d{3}" maxlength="3" placeholder="123" required>
                </div>
            </div>
            <div id="checkout-error" class="text-danger mb-2"></div>
            <button type="submit" class="btn btn-pixel w-100">Place Order</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add QA/test hooks to checkout form fields and button
['name','email','phone','address','card-number','card-expiry','card-cvv'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.setAttribute('data-qa', id);
});
document.getElementById('checkout-form').setAttribute('data-qa', 'checkout-form');
document.querySelector('button[type="submit"]').setAttribute('data-qa', 'place-order-btn');

// Check cart on page load and redirect if empty
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Checkout page loaded, checking cart...');
    const token = localStorage.getItem('token');
    if (!token) {
        console.log('No token found, redirecting to login');
        alert('Please log in to checkout.');
        window.location.href = '/login/';
        return;
    }

    try {
        console.log('Fetching cart from API...');
        const cartRes = await fetch('/api/cart/', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        console.log('Cart response status:', cartRes.status);
        
        if (!cartRes.ok) {
            throw new Error(`Cart API returned ${cartRes.status}`);
        }
        
        const cartData = await cartRes.json();
        console.log('Cart data received:', cartData);
        
        const cartItems = Array.isArray(cartData) ? cartData : (cartData.results || []);
        console.log('Cart items array:', cartItems);
        console.log('Cart items length:', cartItems.length);
        
        if (!cartItems.length) {
            console.log('Cart is empty, redirecting to products');
            alert('Your cart is empty. Please add items before checkout.');
            window.location.href = '/products/';
            return;
        }
        
        console.log('Cart has items, displaying summary');
        // Display cart summary
        const total = cartItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
        const cartSummary = document.createElement('div');
        cartSummary.className = 'alert alert-info mb-3';
        cartSummary.innerHTML = `
            <strong>Cart Summary:</strong> ${cartItems.length} item(s) - Total: $${total.toFixed(2)}
        `;
        document.getElementById('checkout-form').insertBefore(cartSummary, document.getElementById('checkout-form').firstChild);
        
        // Display detailed cart items
        const cartItemsSection = document.createElement('div');
        cartItemsSection.className = 'mb-4';
        cartItemsSection.innerHTML = `
            <h4 style="color:#ff79c6;">Order Items</h4>
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cartItems.map(item => `
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${item.product.image}" alt="${item.product.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
                                        <div>
                                            <strong>${item.product.name}</strong><br>
                                            <small style="color: #ff79c6;">${item.product.brand} â€¢ ${item.product.platform}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>$${item.product.price}</td>
                                <td>${item.quantity}</td>
                                <td>$${(item.product.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td><strong>$${total.toFixed(2)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
        document.getElementById('checkout-form').insertBefore(cartItemsSection, document.getElementById('checkout-form').firstChild);
        
    } catch (error) {
        console.error('Error fetching cart:', error);
        alert('Error loading cart. Please try again.');
        window.location.href = '/cart/';
    }
});

// Buggy behavior: sometimes Place Order is disabled for 5 seconds after load
const placeOrderBtn = document.querySelector('button[type="submit"]');
if (Math.random() < 0.25) {
    placeOrderBtn.disabled = true;
    placeOrderBtn.textContent = 'Please wait...';
    setTimeout(() => {
        placeOrderBtn.disabled = false;
        placeOrderBtn.textContent = 'Place Order';
    }, 5000);
}

document.getElementById('checkout-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const cardNumber = document.getElementById('card-number').value.replace(/\s+/g, '');
    const cardExpiry = document.getElementById('card-expiry').value.trim();
    const cardCVV = document.getElementById('card-cvv').value.trim();
    const errorDiv = document.getElementById('checkout-error');
    const submitBtn = document.querySelector('button[type="submit"]');
    
    errorDiv.textContent = '';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        errorDiv.textContent = 'Please log in to checkout.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Order';
        return;
    }

    // Simple validation for test credentials
    if (cardNumber !== '4242424242424242' || cardExpiry !== '12/34' || cardCVV !== '123') {
        errorDiv.textContent = 'Please use the test card: 4242 4242 4242 4242, Expiry: 12/34, CVV: 123';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Order';
        return;
    }
    
    if (!name || !email || !phone || !address) {
        errorDiv.textContent = 'Please fill in all required fields.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Order';
        return;
    }

    // Fetch cart items and validate
    let cartItems = [];
    let totalPrice = 0;
    try {
        const cartRes = await fetch('/api/cart/', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!cartRes.ok) {
            throw new Error('Failed to fetch cart');
        }
        
        const cartData = await cartRes.json();
        cartItems = Array.isArray(cartData) ? cartData : (cartData.results || []);
        
        if (!cartItems.length) {
            errorDiv.textContent = 'Your cart is empty. Please add items before checkout.';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Place Order';
            return;
        }
        
        // Calculate total price
        totalPrice = cartItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
        
    } catch (error) {
        console.error('Error fetching cart:', error);
        errorDiv.textContent = 'Could not fetch cart items. Please try again.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Order';
        return;
    }

    // Create order via API
    try {
        const orderRes = await fetch('/api/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                items: cartItems.map(item => item.id),
                total_price: totalPrice,
                status: 'pending',
                shipping_name: name,
                shipping_email: email,
                shipping_phone: phone,
                shipping_address: address,
                payment_card: cardNumber,
                payment_expiry: cardExpiry,
                payment_cvv: cardCVV
            })
        });
        
        if (orderRes.ok) {
            const orderData = await orderRes.json();
            alert(`Order placed successfully! Order #${orderData.id}`);
            window.location.href = '/profile/';
        } else {
            const errorData = await orderRes.text();
            try {
                const data = JSON.parse(errorData);
                errorDiv.textContent = data.error || data.detail || 'Order failed.';
            } catch {
                errorDiv.textContent = 'Order failed. Please try again.';
            }
        }
    } catch (error) {
        console.error('Error creating order:', error);
        errorDiv.textContent = 'Order failed. Please try again.';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Order';
    }
});
</script>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
{% endblock %} 